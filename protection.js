/* protection.js */
(function(){const supabase=window.supabaseClient;async function protegerPage(){const{data:{user},error}=await supabase.auth.getUser();if(error||!user){console.log('⛔ Accès refusé - Redirection vers la page de connexion');window.location.href='index.html';return null;}console.log('✅ Utilisateur autorisé:',user.email);return user;}async function checkPageAccess(requiredPermission){const{data:{user}}=await supabase.auth.getUser();if(!user){window.location.href='index.html';return false;}const{data:userRole,error}=await supabase.from('user_role').select('can_access_formation, can_access_incident, is_admin, is_DAA').eq('user_email',user.email).single();if(error){alert('Erreur: '+error.message);window.location.href='dashboard.html';return false;}if(userRole[requiredPermission]===true){return true;}else{alert('Vous n\'avez pas accès à cette page.');window.location.href='dashboard.html';return false;}}async function seDeconnecter(){const{error}=await supabase.auth.signOut();if(!error)window.location.href='index.html';}window.protegerPage=protegerPage;window.checkPageAccess=checkPageAccess;window.seDeconnecter=seDeconnecter;})();
