/* agenda.js */
(function(){const supabase=window.supabaseClient;let currentUser=null;let currentDate=new Date();let allEvents=[];document.addEventListener('DOMContentLoaded',async()=>{const user=await window.protegerPage();if(!user)return;currentUser=user;const emailElement=document.getElementById('userEmail');if(emailElement){emailElement.textContent=user.email;}await initializeAgenda();});async function initializeAgenda(){await loadEvents();renderCalendar();renderEventsList();document.getElementById('prevMonth').addEventListener('click',()=>{currentDate.setMonth(currentDate.getMonth()-1);renderCalendar();});document.getElementById('nextMonth').addEventListener('click',()=>{currentDate.setMonth(currentDate.getMonth()+1);renderCalendar();});document.getElementById('todayBtn').addEventListener('click',()=>{currentDate=new Date();renderCalendar();});document.getElementById('closeModal').addEventListener('click',closeEventModal);document.getElementById('eventModal').addEventListener('click',(e)=>{if(e.target.id==='eventModal'){closeEventModal();}});}async function loadEvents(){try{const{data,error}=await supabase.from('agenda_events').select('*').order('start_datetime',{ascending:true});if(error)throw error;allEvents=data||[];}catch(error){console.error('Erreur lors du chargement des √©v√©nements:',error);alert('Erreur lors du chargement des √©v√©nements');}}function renderCalendar(){const year=currentDate.getFullYear();const month=currentDate.getMonth();const monthNames=['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];document.getElementById('currentMonth').textContent=`${monthNames[month]} ${year}`;const calendarGrid=document.getElementById('calendarGrid');calendarGrid.innerHTML='';const dayNames=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];dayNames.forEach(day=>{const dayHeader=document.createElement('div');dayHeader.className='calendar-day-header';dayHeader.textContent=day;calendarGrid.appendChild(dayHeader);});const firstDay=new Date(year,month,1);const lastDay=new Date(year,month+1,0);let startDay=firstDay.getDay()-1;if(startDay===-1)startDay=6;const prevMonthLastDay=new Date(year,month,0).getDate();for(let i=startDay-1;i>=0;i--){const dayDiv=createDayCell(prevMonthLastDay-i,month-1,year,true);calendarGrid.appendChild(dayDiv);}const today=new Date();for(let day=1;day<=lastDay.getDate();day++){const isToday=day===today.getDate()&&month===today.getMonth()&&year===today.getFullYear();const dayDiv=createDayCell(day,month,year,false,isToday);calendarGrid.appendChild(dayDiv);}const totalCells=calendarGrid.children.length-7;const remainingCells=(7-(totalCells%7))%7;for(let day=1;day<=remainingCells;day++){const dayDiv=createDayCell(day,month+1,year,true);calendarGrid.appendChild(dayDiv);}}function createDayCell(day,month,year,isOtherMonth,isToday=false){const dayDiv=document.createElement('div');dayDiv.className='calendar-day';if(isOtherMonth)dayDiv.classList.add('other-month');if(isToday)dayDiv.classList.add('today');const dayNumber=document.createElement('div');dayNumber.className='calendar-day-number';dayNumber.textContent=day;dayDiv.appendChild(dayNumber);const date=new Date(year,month,day);const dayEvents=getEventsForDay(date);dayEvents.forEach(event=>{const eventDiv=document.createElement('div');eventDiv.className='calendar-event';eventDiv.style.backgroundColor=event.color||'#f59314';eventDiv.textContent=event.title;eventDiv.addEventListener('click',(e)=>{e.stopPropagation();openEventModal(event);});dayDiv.appendChild(eventDiv);});return dayDiv;}function getEventsForDay(date){const dateStr=date.toDateString();return allEvents.filter(event=>{const eventStart=new Date(event.start_datetime);const eventEnd=new Date(event.end_datetime);return eventStart.toDateString()===dateStr||eventEnd.toDateString()===dateStr||(eventStart<date&&eventEnd>date);});}function renderEventsList(){const eventsList=document.getElementById('eventsList');eventsList.innerHTML='';const now=new Date();const upcomingEvents=allEvents.filter(event=>{const eventEnd=new Date(event.end_datetime);return eventEnd>=now;}).slice(0,10);if(upcomingEvents.length===0){eventsList.innerHTML='<p style="color: rgb(150, 150, 150);">Aucun √©v√©nement √† venir</p>';return;}upcomingEvents.forEach(event=>{const eventItem=document.createElement('div');eventItem.className='event-list-item';eventItem.style.borderLeftColor=event.color||'#f59314';const startDate=new Date(event.start_datetime);const endDate=new Date(event.end_datetime);eventItem.innerHTML=`
                <h4>${event.title}</h4>
                <p>üìÖ ${formatDate(startDate)}</p>
                <p>üïê ${formatTime(startDate)} - ${formatTime(endDate)}</p>
                ${event.description ? `<p>üìù ${event.description}</p>` : ''}
            `;eventItem.addEventListener('click',()=>{openEventModal(event);});eventsList.appendChild(eventItem);});}function openEventModal(event=null){if(!event)return;const modal=document.getElementById('eventModal');const modalTitle=document.getElementById('modalTitle');modalTitle.textContent='D√©tails de l\'√©v√©nement';document.getElementById('eventTitle').value=event.title;document.getElementById('eventDescription').value=event.description||'';document.getElementById('eventStart').value=formatDateTimeLocal(new Date(event.start_datetime));document.getElementById('eventEnd').value=formatDateTimeLocal(new Date(event.end_datetime));document.getElementById('eventColor').value=event.color||'#f59314';document.getElementById('eventTitle').disabled=true;document.getElementById('eventDescription').disabled=true;document.getElementById('eventStart').disabled=true;document.getElementById('eventEnd').disabled=true;document.getElementById('eventColor').disabled=true;modal.style.display='block';}function closeEventModal(){document.getElementById('eventModal').style.display='none';document.getElementById('eventTitle').disabled=false;document.getElementById('eventDescription').disabled=false;document.getElementById('eventStart').disabled=false;document.getElementById('eventEnd').disabled=false;document.getElementById('eventColor').disabled=false;}function formatDate(date){const options={weekday:'long',year:'numeric',month:'long',day:'numeric'};return date.toLocaleDateString('fr-FR',options);}function formatTime(date){return date.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});}function formatDateTimeLocal(date){const year=date.getFullYear();const month=String(date.getMonth()+1).padStart(2,'0');const day=String(date.getDate()).padStart(2,'0');const hours=String(date.getHours()).padStart(2,'0');const minutes=String(date.getMinutes()).padStart(2,'0');return `${year}-${month}-${day}T${hours}:${minutes}`;}})();
