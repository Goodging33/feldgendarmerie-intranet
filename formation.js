/* formation.js */
(function(){const supabase=window.supabaseClient;document.addEventListener('DOMContentLoaded',async()=>{const user=await window.protegerPage();if(!user)return;const emailElement=document.getElementById('userEmail');if(emailElement){emailElement.textContent=user.email;}setupPointsCalculation();await chargerFormations();});function setupPointsCalculation(){const pointInputs=['points1','points2','points3','points4','points5'];pointInputs.forEach(inputId=>{const input=document.getElementById(inputId);if(input){input.addEventListener('input',calculerTotal);}});calculerTotal();}function calculerTotal(){const points1=parseInt(document.getElementById('points1').value)||0;const points2=parseInt(document.getElementById('points2').value)||0;const points3=parseInt(document.getElementById('points3').value)||0;const points4=parseInt(document.getElementById('points4').value)||0;const points5=parseInt(document.getElementById('points5').value)||0;const total=points1+points2+points3+points4+points5;document.getElementById('total_points').textContent=`${total}/18`;return total;}window.valider=async function(){try{const{data:{user},error:userError}=await supabase.auth.getUser();if(userError||!user){alert('Erreur : Utilisateur non connect√©');return;}const nomPrenom=document.getElementById('nom_prenom').value.trim();const steamId=document.getElementById('steam_id').value.trim();const grade=document.getElementById('grade-mise').value;const commentaire=document.getElementById('commentaire').value.trim();const points1=parseInt(document.getElementById('points1').value)||0;const points2=parseInt(document.getElementById('points2').value)||0;const points3=parseInt(document.getElementById('points3').value)||0;const points4=parseInt(document.getElementById('points4').value)||0;const points5=parseInt(document.getElementById('points5').value)||0;const total=points1+points2+points3+points4+points5;if(!nomPrenom||!steamId||!grade){alert('Veuillez remplir tous les champs obligatoires (Nom, Steam ID, Grade)');return;}const formationData={nom_prenom:nomPrenom,steam_id:steamId,grade:grade,points_question:points1,points_capture:points2,points_manierisme:points3,points_vip:points4,points_libres:points5,total_points:total,commentaire:commentaire,formateur_email:user.email,statut:total>10?'reussi':'rate',created_at:new Date().toISOString()};const{data,error}=await supabase.from('formations').insert([formationData]);if(error){console.error('Erreur Supabase:',error);alert('Erreur lors de la sauvegarde : '+error.message);return;}alert('‚úÖ Formation enregistr√©e avec succ√®s !');document.getElementById('nom_prenom').value='';document.getElementById('steam_id').value='';document.getElementById('grade-mise').value='';document.getElementById('commentaire').value='';document.getElementById('points1').value='0';document.getElementById('points2').value='0';document.getElementById('points3').value='0';document.getElementById('points4').value='0';document.getElementById('points5').value='0';calculerTotal();await chargerFormations();}catch(error){console.error('Erreur:',error);alert('Une erreur est survenue lors de la sauvegarde');}};async function chargerFormations(){try{const{data:formations,error}=await supabase.from('formations').select('*').order('created_at',{ascending:false});if(error){console.error('Erreur lors du chargement:',error);return;}const recruesReussies=formations.filter(f=>f.total_points>10);const formationsRatees=formations.filter(f=>f.total_points<=10);afficherRecrues(recruesReussies);afficherFormationsRatees(formationsRatees);}catch(error){console.error('Erreur:',error);}}function afficherRecrues(recrues){const box=document.getElementById('recrues_box');if(!recrues||recrues.length===0){box.innerHTML='<p style="color: #999; font-style: italic;">Aucune recrue enregistr√©e</p>';return;}let html='';recrues.forEach(recrue=>{const date=new Date(recrue.created_at).toLocaleDateString('fr-FR');html+=`
                <div style="background-color: rgb(37, 37, 37); padding: 12px; margin-bottom: 12px; border-radius: 5px; border: 3px solid rgb(47, 117, 47);">
                    <p style="color: rgb(245, 147, 20); font-weight: bold; margin-bottom: 8px; font-size: 15px;">${recrue.nom_prenom}</p>
                    <p style="color: rgb(226, 226, 226); font-size: 13px; margin-bottom: 3px;">Grade: ${recrue.grade}</p>
                    <p style="color: rgb(226, 226, 226); font-size: 13px; margin-bottom: 8px;">Steam ID: ${recrue.steam_id}</p>
                    <div style="background-color: rgb(45, 45, 45); padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                        <p style="color: rgb(150, 150, 150); font-size: 11px; font-weight: bold; margin-bottom: 5px;">üìä D√©tail des points:</p>
                        <p style="color: rgb(200, 200, 200); font-size: 12px; margin: 2px 0;">I. Questions: ${recrue.points_question}/4</p>
                        <p style="color: rgb(200, 200, 200); font-size: 12px; margin: 2px 0;">II. Capture: ${recrue.points_capture}/4</p>
                        <p style="color: rgb(200, 200, 200); font-size: 12px; margin: 2px 0;">III. Mani√©risme: ${recrue.points_manierisme}/6</p>
                        <p style="color: rgb(200, 200, 200); font-size: 12px; margin: 2px 0;">IV. VIP: ${recrue.points_vip}/2</p>
                        <p style="color: rgb(200, 200, 200); font-size: 12px; margin: 2px 0;">V. Libres: ${recrue.points_libres}/2</p>
                    </div>
                    <p style="color: rgb(47, 117, 47); font-weight: bold; font-size: 16px; margin-top: 5px;">‚úÖ Total: ${recrue.total_points}/18</p>
                    ${recrue.commentaire ? `<p style="color: #999; font-size: 12px; font-style: italic; margin-top: 8px; padding: 5px; background-color: rgb(45, 45, 45); border-radius: 3px;">"${recrue.commentaire}"</p>` : ''}
                    <p style="color: #999; font-size: 12px; margin-top: 8px;">Form√© par: ${recrue.formateur_email}</p>
                    <p style="color: #999; font-size: 12px;">Le: ${date}</p>
                </div>
            `;});box.innerHTML=html;}function afficherFormationsRatees(formations){const box=document.getElementById('formation_rate_box');if(!formations||formations.length===0){box.innerHTML='<p style="color: #999; font-style: italic;">Aucune formation rat√©e</p>';return;}let html='';formations.forEach(formation=>{const date=new Date(formation.created_at).toLocaleDateString('fr-FR');html+=`
                <div style="background-color: rgb(37, 37, 37); padding: 12px; margin-bottom: 12px; border-radius: 5px; border: 3px solid rgb(180, 50, 50);">
                    <p style="color: rgb(245, 147, 20); font-weight: bold; margin-bottom: 8px; font-size: 15px;">${formation.nom_prenom}</p>
                    <p style="color: rgb(226, 226, 226); font-size: 13px; margin-bottom: 3px;">Grade: ${formation.grade}</p>
                    <p style="color: rgb(226, 226, 226); font-size: 13px; margin-bottom: 8px;">Steam ID: ${formation.steam_id}</p>
                    <div style="background-color: rgb(45, 45, 45); padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                        <p style="color: rgb(150, 150, 150); font-size: 11px; font-weight: bold; margin-bottom: 5px;">üìä D√©tail des points:</p>
                        <p style="color: rgb(200, 200, 200); font-size: 12px; margin: 2px 0;">I. Questions: ${formation.points_question}/4</p>
                        <p style="color: rgb(200, 200, 200); font-size: 12px; margin: 2px 0;">II. Capture: ${formation.points_capture}/4</p>
                        <p style="color: rgb(200, 200, 200); font-size: 12px; margin: 2px 0;">III. Mani√©risme: ${formation.points_manierisme}/6</p>
                        <p style="color: rgb(200, 200, 200); font-size: 12px; margin: 2px 0;">IV. VIP: ${formation.points_vip}/2</p>
                        <p style="color: rgb(200, 200, 200); font-size: 12px; margin: 2px 0;">V. Libres: ${formation.points_libres}/2</p>
                    </div>
                    <p style="color: rgb(180, 50, 50); font-weight: bold; font-size: 16px; margin-top: 5px;">‚ùå Total: ${formation.total_points}/18</p>
                    ${formation.commentaire ? `<p style="color: #999; font-size: 12px; font-style: italic; margin-top: 8px; padding: 5px; background-color: rgb(45, 45, 45); border-radius: 3px;">"${formation.commentaire}"</p>` : ''}
                    <p style="color: #999; font-size: 12px; margin-top: 8px;">Form√© par: ${formation.formateur_email}</p>
                    <p style="color: #999; font-size: 12px;">Le: ${date}</p>
                </div>
            `;});box.innerHTML=html;}})();
