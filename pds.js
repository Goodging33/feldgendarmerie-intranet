let currentUser = null; let serviceEnCours = null; document.addEventListener("DOMContentLoaded", async () => { currentUser = await window.protegerPage(); if (!currentUser) return; const emailElement = document.getElementById("userEmail"); if (emailElement) { emailElement.textContent = currentUser.email; } console.log("Utilisateur connecté :", currentUser.email); await loadServiceStatus(); await loadWeeklyHours(); setupEventListeners(); }); function setupEventListeners() { document.getElementById('btn-prendre-service').addEventListener('click', prendreService); document.getElementById('btn-terminer-service').addEventListener('click', terminerService); document.getElementById('btn-gestion-pds').addEventListener('click', () => { window.location.href = 'gestionpds.html'; }); } async function loadServiceStatus() { const { data, error } = await window.supabaseClient .from('pds_en_cours') .select('*') .eq('user_id', currentUser.id) .eq('termine', false) .single(); if (error && error.code !== 'PGRST116') { console.error('Erreur lors de la vérification du service:', error); return; } serviceEnCours = data; updateButtonStates(); } function updateButtonStates() { const btnPrendre = document.getElementById('btn-prendre-service'); const btnTerminer = document.getElementById('btn-terminer-service'); if (serviceEnCours) { btnPrendre.disabled = true; btnPrendre.style.opacity = '0.5'; btnPrendre.style.cursor = 'not-allowed'; btnTerminer.disabled = false; btnTerminer.style.opacity = '1'; btnTerminer.style.cursor = 'pointer'; } else { btnPrendre.disabled = false; btnPrendre.style.opacity = '1'; btnPrendre.style.cursor = 'pointer'; btnTerminer.disabled = true; btnTerminer.style.opacity = '0.5'; btnTerminer.style.cursor = 'not-allowed'; } } async function prendreService() { if (!currentUser) { alert("Erreur : utilisateur non authentifié."); return; } const maintenant = new Date(); const { data, error } = await window.supabaseClient .from('pds_en_cours') .insert([ { user_id: currentUser.id, email: currentUser.email, heure_debut: maintenant.toISOString(), termine: false } ]) .select() .single(); if (error) { console.error(error); alert('❌ Erreur lors du démarrage du service.'); return; } serviceEnCours = data; updateButtonStates(); alert('✅ Service démarré avec succès !'); } async function terminerService() { if (!currentUser) { alert("Erreur : utilisateur non authentifié."); return; } if (!serviceEnCours) { alert('❌ Aucun service en cours.'); return; } const heureFin = new Date(); const heureDebut = new Date(serviceEnCours.heure_debut); await calculerEtEnregistrerHeures(heureDebut, heureFin); const { error } = await window.supabaseClient .from('pds_en_cours') .update({ termine: true, heure_fin: heureFin.toISOString() }) .eq('id', serviceEnCours.id); if (error) { console.error(error); alert('❌ Erreur lors de la fin du service.'); return; } serviceEnCours = null; updateButtonStates(); await loadWeeklyHours(); alert('✅ Service terminé avec succès !'); } async function calculerEtEnregistrerHeures(debut, fin) { const joursTraites = new Map(); let currentDate = new Date(debut); while (currentDate < fin) { const finJour = new Date(currentDate); finJour.setHours(23, 59, 59, 999); const finPeriode = finJour < fin ? finJour : fin; const heuresTravaillees = (finPeriode - currentDate) / (1000 * 60 * 60); const dateStr = formatDateToYYYYMMDD(currentDate); const plage = { debut: currentDate.toISOString(), fin: finPeriode.toISOString() }; if (joursTraites.has(dateStr)) { const existing = joursTraites.get(dateStr); existing.heures += heuresTravaillees; existing.plages.push(plage); } else { joursTraites.set(dateStr, { heures: heuresTravaillees, plages: [plage] }); } currentDate = new Date(finJour); currentDate.setSeconds(currentDate.getSeconds() + 1); } for (const [dateStr, { heures, plages }] of joursTraites) { await enregistrerHeuresJour(dateStr, heures, plages); } } async function enregistrerHeuresJour(date, heures, nouvellePlages) { const { data: existant, error: selectError } = await window.supabaseClient .from('pds_historique') .select('*') .eq('user_id', currentUser.id) .eq('date', date) .single(); if (selectError && selectError.code !== 'PGRST116') { console.error(selectError); return; } if (existant) { const nouvellesHeures = existant.heures_travaillees + heures; const plagesExistantes = existant.plages || []; const toutesLesPlages = [...plagesExistantes, ...nouvellePlages]; const { error } = await window.supabaseClient .from('pds_historique') .update({ heures_travaillees: nouvellesHeures, plages: toutesLesPlages }) .eq('id', existant.id); if (error) console.error(error); } else { const jourSemaine = getJourSemaineFromDate(date); const { error } = await window.supabaseClient .from('pds_historique') .insert([ { user_id: currentUser.id, email: currentUser.email, date: date, jour_semaine: jourSemaine, heures_travaillees: heures, plages: nouvellePlages } ]); if (error) console.error(error); } } async function loadWeeklyHours() { const aujourdhui = new Date(); const debutSemaine = getDebutSemaine(aujourdhui); const finSemaine = getFinSemaine(aujourdhui); const debutStr = formatDateToYYYYMMDD(debutSemaine); const finStr = formatDateToYYYYMMDD(finSemaine); console.log(`Semaine en cours : ${debutStr} → ${finStr}`); const { data, error } = await window.supabaseClient .from('pds_historique') .select('*') .eq('user_id', currentUser.id) .gte('date', debutStr) .lte('date', finStr); if (error) { console.error(error); return; } const heuresParJour = { 'Samedi': 0, 'Dimanche': 0, 'Lundi': 0, 'Mardi': 0, 'Mercredi': 0, 'Jeudi': 0, 'Vendredi': 0 }; const plagesParJour = { 'Samedi': [], 'Dimanche': [], 'Lundi': [], 'Mardi': [], 'Mercredi': [], 'Jeudi': [], 'Vendredi': [] }; if (data) { data.forEach(entry => { if (heuresParJour.hasOwnProperty(entry.jour_semaine)) { heuresParJour[entry.jour_semaine] += entry.heures_travaillees; if (entry.plages && entry.plages.length > 0) { plagesParJour[entry.jour_semaine].push(...entry.plages); } } }); } let totalHeures = 0; for (const [jour, heures] of Object.entries(heuresParJour)) { const elementId = `count-${jour.toLowerCase()}`; const element = document.getElementById(elementId); if (element) { element.textContent = formatHeures(heures); } const detailId = `detail-${jour.toLowerCase()}`; const detailElement = document.getElementById(detailId); if (detailElement) { const plages = plagesParJour[jour]; if (plages.length > 0) { plages.sort((a, b) => new Date(a.debut) - new Date(b.debut)); detailElement.innerHTML = plages.map(p => { const debut = new Date(p.debut); const fin = new Date(p.fin); return `<span class="plage-detail">${formatHeure(debut)} – ${formatHeure(fin)}</span>`; }).join(''); } else { detailElement.innerHTML = ''; } } totalHeures += heures; } document.getElementById('total-personnel').textContent = formatHeures(totalHeures); } function formatHeure(date) { const h = date.getHours().toString().padStart(2, '0'); const m = date.getMinutes().toString().padStart(2, '0'); return `${h}h${m}`; } function formatHeures(heures) { const h = Math.floor(heures); const minutes = Math.round((heures - h) * 60); return `${h.toString().padStart(2, '0')}h${minutes.toString().padStart(2, '0')}`; } function formatDateToYYYYMMDD(date) { const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; } function getJourSemaine(date) { const jours = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi']; return jours[date.getDay()]; } function getJourSemaineFromDate(dateStr) { const date = new Date(dateStr + 'T12:00:00'); return getJourSemaine(date); } function getDebutSemaine(date) { const d = new Date(date); d.setHours(0, 0, 0, 0); const decalage = { 6: 0, 0: 1, 1: 2, 2: 3, 3: 4, 4: 5, 5: 6 }[d.getDay()]; d.setDate(d.getDate() - decalage); return d; } function getFinSemaine(date) { const debut = getDebutSemaine(date); const fin = new Date(debut); fin.setDate(debut.getDate() + 6); fin.setHours(23, 59, 59, 999); return fin; }