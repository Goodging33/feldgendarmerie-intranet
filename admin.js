/* admin.js */
(function(){const supabase=window.supabaseClient;let currentUser=null;let allEvents=[];let filteredEvents=[];document.addEventListener('DOMContentLoaded',async()=>{const user=await window.protegerPage();if(!user)return;currentUser=user;const emailElement=document.getElementById('userEmail');if(emailElement){emailElement.textContent=user.email;}await initializeAdmin();});async function initializeAdmin(){await loadEvents();document.getElementById('eventForm').addEventListener('submit',handleEventSubmit);document.getElementById('cancelBtn').addEventListener('click',resetForm);document.getElementById('searchInput').addEventListener('input',filterEvents);document.getElementById('filterStatus').addEventListener('change',filterEvents);document.getElementById('eventStart').addEventListener('change',checkOverlap);document.getElementById('eventEnd').addEventListener('change',checkOverlap);renderEventsTable();}async function loadEvents(){try{const{data,error}=await supabase.from('agenda_events').select('*').eq('user_email',currentUser.email).order('start_datetime',{ascending:true});if(error){console.error('Erreur Supabase:',error);throw error;}allEvents=data||[];filteredEvents=[...allEvents];console.log('√âv√©nements charg√©s:',allEvents.length);}catch(error){console.error('Erreur lors du chargement des √©v√©nements:',error);}}function renderEventsTable(){const tbody=document.getElementById('eventsTableBody');tbody.innerHTML='';if(filteredEvents.length===0){tbody.innerHTML=`
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: rgb(150, 150, 150);">
                        Aucun √©v√©nement √† afficher
                    </td>
                </tr>
            `;return;}filteredEvents.forEach(event=>{const row=document.createElement('tr');const startDate=new Date(event.start_datetime);const endDate=new Date(event.end_datetime);row.innerHTML=`
                <td><span class="event-color-badge" style="background-color: ${event.color || '#f59314'}"></span></td>
                <td><strong>${escapeHtml(event.title)}</strong></td>
                <td>${formatDateTime(startDate)}</td>
                <td>${formatDateTime(endDate)}</td>
                <td>${event.description ? escapeHtml(event.description.substring(0, 50)) + (event.description.length > 50 ? '...' : '') : '-'}</td>
                <td>
                    <button class="action-btn edit" onclick="window.editEvent('${event.id}')">‚úèÔ∏è Modifier</button>
                    <button class="action-btn delete" onclick="window.deleteEvent('${event.id}')">üóëÔ∏è Supprimer</button>
                </td>
            `;tbody.appendChild(row);});}function filterEvents(){const searchTerm=document.getElementById('searchInput').value.toLowerCase();const status=document.getElementById('filterStatus').value;const now=new Date();const todayStart=new Date(now.getFullYear(),now.getMonth(),now.getDate());const todayEnd=new Date(todayStart);todayEnd.setDate(todayEnd.getDate()+1);filteredEvents=allEvents.filter(event=>{const matchesSearch=!searchTerm||event.title.toLowerCase().includes(searchTerm)||(event.description&&event.description.toLowerCase().includes(searchTerm));let matchesStatus=true;const eventEnd=new Date(event.end_datetime);const eventStart=new Date(event.start_datetime);if(status==='upcoming'){matchesStatus=eventEnd>=now;}else if(status==='past'){matchesStatus=eventEnd<now;}else if(status==='today'){matchesStatus=(eventStart>=todayStart&&eventStart<todayEnd)||(eventEnd>=todayStart&&eventEnd<todayEnd)||(eventStart<todayStart&&eventEnd>=todayEnd);}return matchesSearch&&matchesStatus;});renderEventsTable();}async function handleEventSubmit(e){e.preventDefault();const eventId=document.getElementById('eventId').value;const title=document.getElementById('eventTitle').value.trim();const description=document.getElementById('eventDescription').value.trim();const startDatetime=new Date(document.getElementById('eventStart').value);const endDatetime=new Date(document.getElementById('eventEnd').value);const color=document.getElementById('eventColor').value;if(endDatetime<=startDatetime){alert('‚ö†Ô∏è La date de fin doit √™tre apr√®s la date de d√©but');return;}const eventData={user_email:currentUser.email,title,description,start_datetime:startDatetime.toISOString(),end_datetime:endDatetime.toISOString(),color,updated_at:new Date().toISOString()};try{if(eventId){const{error}=await supabase.from('agenda_events').update(eventData).eq('id',eventId).eq('user_email',currentUser.email);if(error)throw error;}else{const{error}=await supabase.from('agenda_events').insert([eventData]);if(error)throw error;}showSuccessMessage();await loadEvents();filterEvents();resetForm();}catch(error){console.error('Erreur lors de l\'enregistrement:',error);}}function showSuccessMessage(){const successMsg=document.getElementById('successMessage');successMsg.style.display='block';setTimeout(()=>{successMsg.style.display='none';},3000);}function resetForm(){document.getElementById('eventForm').reset();document.getElementById('eventId').value='';document.getElementById('formTitle').textContent='‚ûï Ajouter un √©v√©nement';document.getElementById('cancelBtn').style.display='none';document.getElementById('overlapWarning').style.display='none';document.getElementById('eventColor').value='#f59314';}window.editEvent=function(eventId){const event=allEvents.find(e=>e.id===eventId);if(!event)return;document.getElementById('formTitle').textContent='‚úèÔ∏è Modifier l\'√©v√©nement';document.getElementById('cancelBtn').style.display='inline-block';document.getElementById('eventId').value=event.id;document.getElementById('eventTitle').value=event.title;document.getElementById('eventDescription').value=event.description||'';document.getElementById('eventStart').value=formatDateTimeLocal(new Date(event.start_datetime));document.getElementById('eventEnd').value=formatDateTimeLocal(new Date(event.end_datetime));document.getElementById('eventColor').value=event.color||'#f59314';document.querySelector('.admin-section').scrollIntoView({behavior:'smooth'});};window.deleteEvent=async function(eventId){const event=allEvents.find(e=>e.id===eventId);if(!event)return;if(!confirm(`üóëÔ∏è √ätes-vous s√ªr de vouloir supprimer l'√©v√©nement "${event.title}" ?`)){return;}try{const{error}=await supabase.from('agenda_events').delete().eq('id',eventId).eq('user_email',currentUser.email);if(error)throw error;await loadEvents();filterEvents();resetForm();showSuccessMessage();}catch(error){console.error('Erreur lors de la suppression:',error);}};function checkOverlap(){const eventId=document.getElementById('eventId').value;const startInput=document.getElementById('eventStart').value;const endInput=document.getElementById('eventEnd').value;if(!startInput||!endInput)return;const startDatetime=new Date(startInput);const endDatetime=new Date(endInput);const warningDiv=document.getElementById('overlapWarning');const hasOverlap=allEvents.some(event=>{if(eventId&&event.id===eventId)return false;const eventStart=new Date(event.start_datetime);const eventEnd=new Date(event.end_datetime);return((startDatetime>=eventStart&&startDatetime<eventEnd)||(endDatetime>eventStart&&endDatetime<=eventEnd)||(startDatetime<=eventStart&&endDatetime>=eventEnd));});warningDiv.style.display=hasOverlap?'block':'none';}function formatDateTime(date){const options={year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'};return date.toLocaleDateString('fr-FR',options);}function formatDateTimeLocal(date){const year=date.getFullYear();const month=String(date.getMonth()+1).padStart(2,'0');const day=String(date.getDate()).padStart(2,'0');const hours=String(date.getHours()).padStart(2,'0');const minutes=String(date.getMinutes()).padStart(2,'0');return `${year}-${month}-${day}T${hours}:${minutes}`;}function escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML;}})();
