/* extincident.js */
function genererTicketID(){const timestamp=Date.now();const random=Math.floor(Math.random()*10000);return `TICKET-${timestamp}-${random}`;}async function creerDemande(){try{const nomPrenomVous=document.getElementById('nom-prenom-auteur').value;const gradeVous=document.getElementById('grade-auteur').value;const regimentVous=document.getElementById('regiment-auteur').value;const nomPrenomMise=document.getElementById('nom-prenom-mise').value;const gradeMise=document.getElementById('grade-mise').value;const regimentMise=document.getElementById('regiment-mise').value;const contenue=document.getElementById('contenue').value;if(!nomPrenomVous||!gradeVous||!regimentVous||!nomPrenomMise||!gradeMise||!regimentMise||!contenue){alert('❌ Veuillez remplir tous les champs obligatoires !');return;}const ticketID=genererTicketID();const donneesIncident={ticket_id:ticketID,nom_prenom_auteur:nomPrenomVous,grade_auteur:gradeVous,regiment_auteur:regimentVous,nom_prenom_mise_en_cause:nomPrenomMise,grade_mise_en_cause:gradeMise,regiment_mise_en_cause:regimentMise,contenu:contenue,statut:'En attente',date_creation:new Date().toISOString()};const{data,error}=await window.supabaseClient.from('incidents').insert([donneesIncident]);if(error){console.error('Erreur Supabase:',error);alert('❌ Erreur lors de la création de la demande : '+error.message);return;}alert(`✅ Sauvegardez cette ID:\n\n${ticketID}\n\nVous pourrez retrouver votre demande avec ce numéro.`);alert('✅ Demande créée avec succès !');document.getElementById('nom-prenom-auteur').value='';document.getElementById('grade-auteur').value='';document.getElementById('regiment-auteur').value='';document.getElementById('nom-prenom-mise').value='';document.getElementById('grade-mise').value='';document.getElementById('regiment-mise').value='';document.getElementById('contenue').value='';}catch(error){console.error('Erreur:',error);alert('❌ Une erreur est survenue : '+error.message);}}async function rechercherDemande(){try{const numeroTicket=document.getElementById('numero-ticket').value.trim();if(!numeroTicket){alert('❌ Veuillez entrer un numéro de ticket !');return;}const{data,error}=await window.supabaseClient.from('incidents').select('*').eq('ticket_id',numeroTicket).single();if(error){if(error.code==='PGRST116'){alert('❌ Aucun ticket trouvé avec cet ID !');}else{console.error('Erreur Supabase:',error);alert('❌ Erreur lors de la recherche : '+error.message);}return;}if(data){localStorage.setItem('ticketData',JSON.stringify(data));window.location.href='detail-ticket.html';}}catch(error){console.error('Erreur:',error);alert('❌ Une erreur est survenue : '+error.message);}}document.addEventListener('DOMContentLoaded',function(){const btnCreation=document.getElementById('btnCréation');if(btnCreation){btnCreation.addEventListener('click',creerDemande);}const btnRecherche=document.getElementById('btnRecherche');if(btnRecherche){btnRecherche.addEventListener('click',rechercherDemande);}const idPerdu=document.getElementById('idperdu');const messageOubli=document.getElementById('messageOubli');idPerdu.addEventListener('click',()=>{if(messageOubli.style.display==='none'){messageOubli.style.display='block';}else{messageOubli.style.display='none';}});const inputTicket=document.getElementById('numero-ticket');if(inputTicket){inputTicket.addEventListener('keypress',function(e){if(e.key==='Enter'){rechercherDemande();}});}});
