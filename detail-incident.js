/* detail-incident.js */
function formaterDate(dateISO){const date=new Date(dateISO);return date.toLocaleDateString("fr-FR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});}function getTicketIdFromURL(){const params=new URLSearchParams(window.location.search);return params.get("id");}async function chargerTicketDepuisSupabase(ticketId){const{data,error}=await window.supabaseClient.from("incidents").select("*").eq("ticket_id",ticketId).single();if(error){alert("❌ Ticket introuvable");window.location.href="incident.html";return null;}return data;}let ticketActuel=null;let modeEdition=false;async function afficherTicket(){const ticketId=getTicketIdFromURL();ticketActuel=await chargerTicketDepuisSupabase(ticketId);if(!ticketActuel)return;document.getElementById("ticket-id").textContent=ticketActuel.ticket_id;document.getElementById("date-creation").textContent=formaterDate(ticketActuel.date_creation);afficherStatut(ticketActuel.statut);document.getElementById("nom-auteur").textContent=ticketActuel.nom_prenom_auteur;document.getElementById("grade-auteur").textContent=ticketActuel.grade_auteur;document.getElementById("regiment-auteur").textContent=ticketActuel.regiment_auteur;document.getElementById("nom-mise-en-cause").textContent=ticketActuel.nom_prenom_mise_en_cause;document.getElementById("grade-mise-en-cause").textContent=ticketActuel.grade_mise_en_cause;document.getElementById("regiment-mise-en-cause").textContent=ticketActuel.regiment_mise_en_cause;document.getElementById("contenu").textContent=ticketActuel.contenu;await chargerNotesDGJI(ticketId);chargerHistorique(ticketActuel.ticket_id);}function afficherStatut(statut){const badge=document.getElementById("statut-badge");badge.textContent=statut;switch(statut.toLowerCase()){case "en attente":badge.className="statut-badge statut-en-attente";break;case "traité d.a.a":badge.className="statut-badge statut-en-cours";break;case "traité":badge.className="statut-badge statut-resolu";break;default:badge.className="statut-badge statut-ferme";}}function rendreEditable(id,multiline=false){const el=document.getElementById(id);const val=el.textContent;el.innerHTML=multiline?`<textarea id="${id}-input" style="width:100%;min-height:150px;">${val}</textarea>`:`<input id="${id}-input" type="text" value="${val}" style="width:100%;">`;}function restaurerTexte(id){const input=document.getElementById(`${id}-input`);if(input)document.getElementById(id).textContent=input.value;}async function enregistrerHistorique(ticketId,champ,ancien,nouveau,auteur){if(ancien===nouveau)return;await window.supabaseClient.from("incident_history").insert([{ticket_id:ticketId,champ:champ,ancienne_valeur:ancien,nouvelle_valeur:nouveau,modifie_par:auteur}]);}async function chargerHistorique(ticketId){const{data}=await window.supabaseClient.from("incident_history").select("*").eq("ticket_id",ticketId).order("date_modification",{ascending:false});const container=document.getElementById("historique");if(!container)return;container.innerHTML="";data.forEach(h=>{const div=document.createElement("div");div.style.background="rgb(37,37,37)";div.style.border="1px solid black";div.style.padding="10px";div.style.marginBottom="10px";div.innerHTML=`
            <strong>${h.champ}</strong><br>
            <span style="color:#aaa">Ancien :</span> ${h.ancienne_valeur || "—"}<br>
            <span style="color:#aaa">Nouveau :</span> ${h.nouvelle_valeur}<br>
            <span style="font-size:12px;color:#777">
                ${formaterDate(h.date_modification)} — ${h.modifie_par}
            </span>
        `;container.appendChild(div);});}async function chargerNotesDGJI(ticketId){try{const{data,error}=await window.supabaseClient.from('incidents').select('dgji_notes, dgji_last_update').eq('ticket_id',ticketId).single();if(error){console.error('Erreur chargement notes DGJI:',error);return;}const notesElement=document.getElementById('dgji-notes');const lastUpdateElement=document.getElementById('dgji-last-update');if(notesElement&&data.dgji_notes){notesElement.value=data.dgji_notes;}if(lastUpdateElement&&data.dgji_last_update){lastUpdateElement.textContent=`Dernière modification: ${formaterDate(data.dgji_last_update)}`;}}catch(error){console.error('Erreur:',error);}}async function sauvegarderNotesDGJI(){const ticketId=getTicketIdFromURL();const notes=document.getElementById('dgji-notes').value;try{const{error}=await window.supabaseClient.from('incidents').update({dgji_notes:notes,dgji_last_update:new Date().toISOString()}).eq('ticket_id',ticketId);if(error){console.error('Erreur sauvegarde:',error);alert('❌ Erreur lors de la sauvegarde des notes DGJI');return;}const successMsg=document.getElementById('dgji-success');if(successMsg){successMsg.style.display='block';setTimeout(()=>{successMsg.style.display='none';},3000);}const lastUpdateElement=document.getElementById('dgji-last-update');if(lastUpdateElement){lastUpdateElement.textContent=`Dernière modification: ${formaterDate(new Date().toISOString())}`;}}catch(error){console.error('Erreur:',error);alert('❌ Erreur lors de la sauvegarde des notes DGJI');}}document.getElementById("btnModifier").addEventListener("click",async()=>{if(!modeEdition){modeEdition=true;btnModifier.textContent="✔ Confirmer";rendreEditable("nom-auteur");rendreEditable("grade-auteur");rendreEditable("regiment-auteur");rendreEditable("nom-mise-en-cause");rendreEditable("grade-mise-en-cause");rendreEditable("regiment-mise-en-cause");rendreEditable("contenu",true);const badge=document.getElementById("statut-badge");badge.innerHTML=`
            <select id="statutSelect">
                <option>En attente</option>
                <option>Traité D.A.A</option>
                <option>Traité</option>
                <option value="custom">Personnalisé</option>
            </select>
            <input id="statutCustom" placeholder="Statut personnalisé" style="display:none;width:100%;margin-top:5px;">
        `;const select=document.getElementById("statutSelect");const custom=document.getElementById("statutCustom");select.value=ticketActuel.statut;select.addEventListener("change",()=>{custom.style.display=select.value==="custom"?"block":"none";});}else{const select=document.getElementById("statutSelect");const custom=document.getElementById("statutCustom");const nouveauStatut=select.value==="custom"?custom.value.trim():select.value;const modifiePar="ADMIN";const updateData={statut:nouveauStatut,nom_prenom_auteur:document.getElementById("nom-auteur-input").value,grade_auteur:document.getElementById("grade-auteur-input").value,regiment_auteur:document.getElementById("regiment-auteur-input").value,nom_prenom_mise_en_cause:document.getElementById("nom-mise-en-cause-input").value,grade_mise_en_cause:document.getElementById("grade-mise-en-cause-input").value,regiment_mise_en_cause:document.getElementById("regiment-mise-en-cause-input").value,contenu:document.getElementById("contenu-input").value};for(const champ in updateData){await enregistrerHistorique(ticketActuel.ticket_id,champ,ticketActuel[champ],updateData[champ],modifiePar);}await window.supabaseClient.from("incidents").update(updateData).eq("ticket_id",ticketActuel.ticket_id);Object.values({"nom_prenom_auteur":"nom-auteur","grade_auteur":"grade-auteur","regiment_auteur":"regiment-auteur","nom_prenom_mise_en_cause":"nom-mise-en-cause","grade_mise_en_cause":"grade-mise-en-cause","regiment_mise_en_cause":"regiment-mise-en-cause","contenu":"contenu"}).forEach(restaurerTexte);afficherStatut(nouveauStatut);btnModifier.textContent="Modifier";modeEdition=false;ticketActuel=await chargerTicketDepuisSupabase(ticketActuel.ticket_id);chargerHistorique(ticketActuel.ticket_id);}});const btnSaveDGJI=document.getElementById('btnSaveDGJI');if(btnSaveDGJI){btnSaveDGJI.addEventListener('click',sauvegarderNotesDGJI);}document.addEventListener("DOMContentLoaded",afficherTicket);
