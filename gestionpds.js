function getDebutSemaine(date) { const d = new Date(date); d.setHours(0, 0, 0, 0); const decalage = { 6: 0, 0: 1, 1: 2, 2: 3, 3: 4, 4: 5, 5: 6 }[d.getDay()]; d.setDate(d.getDate() - decalage); return d; } function getFinSemaine(samedi) { const d = new Date(samedi); d.setDate(d.getDate() + 6); d.setHours(23, 59, 59, 999); return d; } function getBornesSemaineEnCours() { const debut = getDebutSemaine(new Date()); return { debut, fin: getFinSemaine(debut) }; } function getBornesSemainePrecedente() { const debutCours = getDebutSemaine(new Date()); const finPrec = new Date(debutCours); finPrec.setDate(finPrec.getDate() - 1); const debutPrec = getDebutSemaine(finPrec); return { debut: debutPrec, fin: getFinSemaine(debutPrec) }; } function toYMD(date) { const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; } function formatHeures(heures) { const h = Math.floor(heures); const min = Math.round((heures - h) * 60); if (h === 0 && min === 0) return '0h 0min'; return `${h}h ${min}min`; } function labelSemaine(debut) { const fin = new Date(debut); fin.setDate(debut.getDate() + 6); const opts = { day: '2-digit', month: 'long' }; const optsA = { day: '2-digit', month: 'long', year: 'numeric' }; return `Sam. ${debut.toLocaleDateString('fr-FR', opts)} ‚Üí Ven. ${fin.toLocaleDateString('fr-FR', optsA)}`; } async function fetchHistorique(debut, fin) { const { data, error } = await window.supabaseClient .from('pds_historique') .select('*') .gte('date', toYMD(debut)) .lte('date', toYMD(fin)) .order('date', { ascending: true }); if (error) { console.error('fetchHistorique :', error); return []; } return data || []; } async function fetchServicesEnCours() { const { data, error } = await window.supabaseClient .from('pds_en_cours') .select('user_id') .eq('termine', false); if (error) { console.error('fetchServicesEnCours :', error); return []; } return data || []; } async function fetchArchives() { const { data, error } = await window.supabaseClient .from('pds_archives') .select('*') .order('week_key', { ascending: false }); if (error) { console.error('fetchArchives :', error); return []; } return data || []; } async function archiverSemainePrecedente(force = false) { const { debut, fin } = getBornesSemainePrecedente(); const weekKey = toYMD(debut); const { data: existante } = await window.supabaseClient .from('pds_archives') .select('id') .eq('week_key', weekKey) .maybeSingle(); if (existante && !force) { console.log(`Archive ${weekKey} d√©j√† pr√©sente.`); return; } const historique = await fetchHistorique(debut, fin); const joueurs = regrouperJoueurs(historique, []); if (joueurs.length === 0) { console.log(`Aucun joueur actif semaine ${weekKey}, pas d'archive cr√©√©e.`); return; } const snapshot = joueurs.map(j => ({ user_id: j.user_id, email: j.email, total: j.total, jours: j.jours })); const { error } = await window.supabaseClient .from('pds_archives') .upsert( { week_key: weekKey, week_label: labelSemaine(debut), data: snapshot, archived_at: new Date().toISOString() }, { onConflict: 'week_key' } ); if (error) { console.error('Erreur archivage :', error); return false; } else { console.log(`‚úÖ Archive cr√©√©e : ${weekKey}`); return true; } } function regrouperJoueurs(historique, servicesActifs) { const actifsIds = new Set(servicesActifs.map(s => s.user_id)); const map = {}; historique.forEach(entry => { if (!map[entry.user_id]) { map[entry.user_id] = { user_id: entry.user_id, email: entry.email, total: 0, jours: [], enService: actifsIds.has(entry.user_id) }; } const h = parseFloat(entry.heures_travaillees) || 0; map[entry.user_id].total += h; map[entry.user_id].jours.push({ date: entry.date, jour: entry.jour_semaine, heures: h, plages: entry.plages || [] }); }); return Object.values(map) .filter(j => j.total > 0) .sort((a, b) => b.total - a.total); } function formatHeure(isoStr) { const d = new Date(isoStr); return `${String(d.getHours()).padStart(2,'0')}h${String(d.getMinutes()).padStart(2,'0')}`; } function renderCarteJoueur(joueur) { const joursHTML = joueur.jours .sort((a, b) => a.date.localeCompare(b.date)) .map(j => { const plagesHTML = j.plages && j.plages.length > 0 ? j.plages .sort((a, b) => new Date(a.debut) - new Date(b.debut)) .map(p => ` <span class="plage-horaire">${formatHeure(p.debut)} ‚Äì ${formatHeure(p.fin)}</span> `).join('') : ''; return ` <div class="pds-session-item"> <div class="session-header"> <span class="session-jour">${j.jour}</span> <span class="session-date">${new Date(j.date + 'T12:00:00').toLocaleDateString('fr-FR')}</span> <span class="session-duree">Total : ${formatHeures(j.heures)}</span> </div> ${plagesHTML ? `<div class="session-plages">${plagesHTML}</div>` : ''} </div> `; }).join(''); const badgeService = joueur.enService ? `<span class="badge-en-service">üî¥ En service</span>` : ''; return ` <div class="pds-card"> <div class="pds-player-header"> <div class="pds-player-name">üë§ ${joueur.email}</div> ${badgeService} </div> <div class="pds-total">‚è± Total semaine : ${formatHeures(joueur.total)}</div> <div class="pds-label">D√©tail par jour :</div> <div class="pds-sessions"> ${joursHTML || '<span class="pds-empty">Aucune entr√©e</span>'} </div> </div> `; } async function afficherSemaineEnCours() { const container = document.getElementById('semaine-en-cours'); const counter = document.getElementById('count-semaine-cours'); const { debut, fin } = getBornesSemaineEnCours(); console.log(`Semaine en cours : ${toYMD(debut)} ‚Üí ${toYMD(fin)}`); const [historique, servicesActifs] = await Promise.all([ fetchHistorique(debut, fin), fetchServicesEnCours() ]); const joueurs = regrouperJoueurs(historique, servicesActifs); counter.textContent = joueurs.length; if (joueurs.length === 0) { container.innerHTML = ` <div class="no-data"> Aucune prise de service pour la semaine en cours<br> <small>(${labelSemaine(debut)})</small> </div>`; return; } container.innerHTML = joueurs.map(renderCarteJoueur).join(''); } async function afficherSemainesPrecedentes() { const container = document.getElementById('semaines-precedentes'); const counter = document.getElementById('count-semaines-precedentes'); const archives = await fetchArchives(); counter.textContent = archives.length; if (archives.length === 0) { container.innerHTML = `<div class="no-data">Aucune semaine archiv√©e pour le moment.</div>`; return; } container.innerHTML = archives.map(archive => { const nb = Array.isArray(archive.data) ? archive.data.filter(j => j.total > 0).length : 0; return ` <div class="semaine-card" onclick="ouvrirModal('${archive.week_key}')"> <div class="semaine-label">üìÖ ${archive.week_label}</div> <div class="semaine-sub">${nb} joueur(s) actif(s) cette semaine-l√†</div> </div> `; }).join(''); } let cacheArchives = null; async function ouvrirModal(weekKey) { const overlay = document.getElementById('modal-semaine'); const titre = document.getElementById('modal-titre'); const content = document.getElementById('modal-content'); overlay.classList.add('active'); content.innerHTML = `<div class="loading">Chargement‚Ä¶</div>`; if (!cacheArchives) { cacheArchives = await fetchArchives(); } const archive = cacheArchives.find(a => a.week_key === weekKey); if (!archive) { content.innerHTML = `<div class="no-data">Archive introuvable.</div>`; return; } titre.textContent = `üìã ${archive.week_label}`; const joueurs = (archive.data || []).filter(j => j.total > 0); content.innerHTML = joueurs.length === 0 ? `<div class="no-data">Aucun joueur actif cette semaine-l√†.</div>` : joueurs.map(j => renderCarteJoueur({ user_id: j.user_id, email: j.email, total: j.total, jours: j.jours || [], enService: false })).join(''); } function fermerModal() { document.getElementById('modal-semaine').classList.remove('active'); } window.initGestionPDS = async function () { await Promise.all([ afficherSemaineEnCours(), afficherSemainesPrecedentes() ]); document.getElementById('modal-semaine')?.addEventListener('click', function(e) { if (e.target === this) fermerModal(); }); document.getElementById('btn-archiver')?.addEventListener('click', async () => { const btn = document.getElementById('btn-archiver'); btn.disabled = true; btn.textContent = 'Archivage en cours‚Ä¶'; const { debut } = getBornesSemainePrecedente(); const label = labelSemaine(debut); const ok = await archiverSemainePrecedente(true); if (ok) { alert(`‚úÖ Semaine archiv√©e !\n${label}`); cacheArchives = null; await afficherSemainesPrecedentes(); } else { alert(`‚ùå Erreur lors de l'archivage. Consulte la console.`); } btn.disabled = false; btn.textContent = 'üì¶ Archiver la semaine pr√©c√©dente'; }); setInterval(async () => { cacheArchives = null; await afficherSemaineEnCours(); }, 60_000); };